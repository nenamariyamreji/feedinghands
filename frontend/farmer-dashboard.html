<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Farmer Dashboard - Feeding-Hands</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <header class="main-header">
        <div class="nav-container">
            <a href="index.html" class="logo">
                <img src="https://img.icons8.com/plasticine/100/wheat.png" alt="Feeding-Hands Logo" class="logo-img">
                Feeding-Hands
            </a>
            <nav class="main-nav">
                <a href="index.html" class="nav-link"><i class="fas fa-home"></i> Home</a>
                <a href="donor-dashboard.html" class="nav-link"><i class="fas fa-heart"></i> Food Donor</a>
                <a href="ngo.html" class="nav-link"><i class="fas fa-hands-helping"></i> NGO</a>
                <a href="farmer-dashboard.html" class="nav-link active"><i class="fas fa-leaf"></i> Farmer</a>
                <a href="#" id="logout-link" class="nav-link"><i class="fas fa-sign-out-alt"></i> Logout</a>
            </nav>
        </div>
    </header>

    <main class="dashboard-page">
        <div class="container">
            <div class="dashboard-header">
                <div>
                    <h1>Farmer Dashboard</h1>
                    <p>Welcome, <span id="farmer-name"></span></p>
                </div>
            </div>

            <div class="dashboard-stats-grid">
                <!-- Stats will be loaded here -->
            </div>

            <!-- NEW: Manage Farm Section -->
            <div class="manage-farm-container">
                <h2><i class="fas fa-tractor"></i> Manage Your Farm</h2>
                <form id="farm-profile-form">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="farmSize">Farm Size (in acres)</label>
                            <input type="number" id="farmSize" name="farmSize" placeholder="e.g., 25">
                        </div>
                        <div class="form-group">
                            <label for="primaryCrops">Primary Crops (comma-separated)</label>
                            <input type="text" id="primaryCrops" name="primaryCrops" placeholder="e.g., Wheat, Rice, Cotton">
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">Save Profile</button>
                </form>
            </div>


            <div class="tabs-container">
                <div class="tabs">
                    <button class="tab-link active" onclick="openTab(event, 'market-prices')"><i class="fas fa-chart-bar"></i> Market Prices</button>
                    <button class="tab-link" onclick="openTab(event, 'demand-insights')"><i class="fas fa-lightbulb"></i> Demand Insights</button>
                </div>

                <div id="market-prices" class="tab-content active">
                    <h3>Your Primary Crops - Market Prices</h3>
                    <div class="market-prices-grid">
                        <!-- Market prices will be loaded here -->
                    </div>
                </div>

                <div id="demand-insights" class="tab-content">
                    <div class="demand-chart-container">
                         <h3>Total Demand by Ingredient</h3>
                        <canvas id="demandChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const token = localStorage.getItem('token');
            const user = JSON.parse(localStorage.getItem('user'));

            if (!token || !user || user.role !== 'farmer') {
                alert('You must be logged in as a farmer to view this page.');
                window.location.href = 'login.html';
                return;
            }

            document.getElementById('farmer-name').textContent = user.name;
            fetchFarmerDashboardData();

            document.getElementById('logout-link').addEventListener('click', (e) => {
                e.preventDefault();
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                window.location.href = 'index.html';
            });

            // Handle farm profile update
            document.getElementById('farm-profile-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const farmSize = document.getElementById('farmSize').value;
                const primaryCrops = document.getElementById('primaryCrops').value.split(',').map(crop => crop.trim());

                try {
                    const response = await fetch('http://localhost:5000/api/farmer/profile', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ farmSize, primaryCrops })
                    });
                    if (!response.ok) throw new Error('Failed to update profile.');
                    alert('Profile updated successfully!');
                    fetchFarmerDashboardData(); // Refresh dashboard data
                } catch (error) {
                    alert(error.message);
                }
            });
        });

        function openTab(evt, tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-link').forEach(link => link.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            evt.currentTarget.classList.add('active');
        }

        async function fetchFarmerDashboardData() {
            const token = localStorage.getItem('token');
            try {
                const response = await fetch('http://localhost:5000/api/farmer/dashboard', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!response.ok) throw new Error('Failed to fetch dashboard data.');

                const data = await response.json();

                // Populate stats
                const statsGrid = document.querySelector('.dashboard-stats-grid');
                statsGrid.innerHTML = data.stats.map(stat => `
                    <div class="dashboard-stat-card">
                        <div class="stat-card-content">
                            <p>${stat.label}</p>
                            <h3>${stat.value}</h3>
                        </div>
                        <div class="stat-card-icon blue"><i class="fas ${stat.icon}"></i></div>
                    </div>
                `).join('');

                // Populate farm management form with existing data
                document.getElementById('farmSize').value = data.farmSize || '';
                document.getElementById('primaryCrops').value = data.primaryCrops.join(', ');

                // Populate market prices
                const marketPricesGrid = document.querySelector('.market-prices-grid');
                if (Object.keys(data.marketPrices).length > 0) {
                    marketPricesGrid.innerHTML = Object.entries(data.marketPrices).map(([crop, price]) => `
                        <div class="market-price-card">
                            <h4>${crop}</h4>
                            <p class="price">â‚¹${price.toLocaleString()}</p>
                            <span class="price-unit">per quintal</span>
                        </div>
                    `).join('');
                } else {
                    marketPricesGrid.innerHTML = "<p>Add your primary crops in the 'Manage Your Farm' section to see market prices.</p>";
                }
                
                // Render Chart
                if (data.chartData.labels.length > 0) {
                    renderDemandChart(data.chartData);
                }

            } catch (error) {
                console.error(error);
                alert('Could not load dashboard data. Please try again.');
            }
        }

        function renderDemandChart(chartData) {
            const ctx = document.getElementById('demandChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: chartData.labels,
                    datasets: [{
                        label: 'Total Demand (kg)',
                        data: chartData.data,
                        backgroundColor: '#4CAF50',
                        borderRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: 'Quantity (kg)' } },
                        x: { grid: { display: false } }
                    }
                }
            });
        }
    </script>
</body>
</html>
